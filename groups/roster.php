<?phprequire_once "../library.inc.php";$id = (isset ($_GET["id"]) ? $_GET["id"] : header ("Location: index.php?flag=script+logic+error+(R1)"));$mode = (isset ($_GET["mode"]) ? $_GET["mode"] : "view");if ($mode == "csv"){	if ($id)	{	mysql_query ('drop temporary table ta, tp, te');	$ta = 'create temporary table ta (select c1.contact_id, a.address_id, at.rank, min(at.rank) as min_a_rank		   from contacts as c1		   join address_associations as aa on aa.contact_id = c1.contact_id		   join addresses as a on a.address_id = aa.address_id		   join address_types as at on at.address_type_id = a.address_type_id		   group by c1.contact_id		   having at.rank = min_a_rank		   order by c1.contact_id asc, at.rank asc); ';	mysql_query ($ta) or exit (mysql_error());	$tp = 'create temporary table tp (select c2.contact_id, p.phone_id, pt.rank, min(pt.rank) as min_p_rank		   from contacts as c2		   join phone_associations as pa on pa.contact_id = c2.contact_id		   join phones as p on p.phone_id = pa.phone_id		   join phone_types as pt on pt.phone_type_id = p.phone_type_id		   group by c2.contact_id		   having pt.rank = min_p_rank		   order by c2.contact_id asc, pt.rank asc); ';	mysql_query ($tp) or exit (mysql_error());	$te = 'create temporary table te (select c3.contact_id, e.email_id, et.rank, min(et.rank) as min_e_rank		   from contacts as c3		   join email_associations as ea on ea.contact_id = c3.contact_id		   join emails as e on e.email_id = ea.email_id		   join email_types as et on et.email_type_id = e.email_type_id		   group by c3.contact_id		   having et.rank = min_e_rank		   order by c3.contact_id asc, et.rank asc); ';	mysql_query ($te) or exit (mysql_error());	$sql = "select r.year, g.`group`, g.short_name, l.role, l.is_staff,			  c.first_name, c.nickname, c.primary_name, d.degree,			  a.street_address_1, a.street_address_2, a.city, a.state, a.postal_code, a.country,			  p.number, p.formatted, e.email			  from contacts as c			  left join degrees as d on d.degree_id = c.degree_id			  join roster_memberships as m on m.contact_id = c.contact_id			  left join roles as l on l.role_id = m.role_id			  join rosters as r on r.roster_id = m.roster_id			  join groups as g on g.group_id = r.group_id			  left join ta on c.contact_id = ta.contact_id			  left join addresses as a on a.address_id = ta.address_id			  left join tp on c.contact_id = tp.contact_id			  left join phones as p on p.phone_id = tp.phone_id			  left join te on c.contact_id = te.contact_id			  left join emails as e on e.email_id = te.email_id			  where r.roster_id = '$id'			  order by r.year asc, g.`group` asc, l.is_staff asc, c.primary_name asc, c.first_name asc;";	//$roster = mysql_query ($ta . $tp . $te . $sql) or exit (mysql_error());	$roster = mysql_query ($sql) or exit (mysql_error());	header('Content-Type: text/x-csv');	header('Expires: ' . gmdate('D, d M Y H:i:s') . ' GMT');	// lem9 & loic1: IE need specific headers	//if (PMA_USR_BROWSER_AGENT == 'IE') {		header('Content-Disposition: inline; filename="rosters.csv"');		header('Cache-Control: must-revalidate, post-check=0, pre-check=0');		header('Pragma: no-cache');	/*} else {		header('Content-Disposition: attachment; filename="' . $filename . '"');		header('Pragma: no-cache');	}*/	echo '"year","group","short_name","role","is_staff","first_name","nickname","primary_name","degree","street_address_1","street_address_2","city","state","postal_code","country","phone","email"' . "\r";	while ($row = mysql_fetch_assoc ($roster))	{		$output = '';		while (list ($field, $value) = each ($row))		{			$add = true;			switch ($field)			{				case 'country':					if ($value == 'United States') $value = NULL;					break;				case 'role':					if ($value == 'Trekker') $value = NULL;					break;				case 'is_staff':					if ($value) $value = 'Staff';					else $value = NULL;					break;				case 'number':					if ($value && !$row['formatted']) $value = dbPhone ($value);					break;				case 'formatted':					$add = false;			}			if ($add) $output = dbAddToList ($output, ($value ? "\"$value\"" : ''), ',');		}		echo "$output\r";	}	mysql_query ('drop temporary table ta, tp, te');	mysql_free_result ($roster);}}else{$flag = (isset ($_GET["flag"]) ? stripslashes ($_GET["flag"]) : NULL);$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` JOIN `roster_memberships` AS m ON m.`roster_id` = r.`roster_id` JOIN `contacts` AS c ON c.`contact_id` = m.`contact_id` LEFT JOIN `roles` AS l ON l.`role_id` = m.`role_id` WHERE r.`roster_id` = '$id' ORDER BY l.`is_staff` ASC, c.`primary_name` ASC, c.`first_name` ASC";$roster = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R2)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` = '$id' LIMIT 1";$result = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R3)");$group = mysql_fetch_assoc ($result) or header ("Location: index.php?flag=script+logic+error+(R4)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . $group["year"] . "' ORDER BY `excluded` ASC, `group` ASC";$groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R5)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . ($group["year"] - 1) . "' AND r.`year` >= '1926' ORDER BY `excluded` ASC, `group` ASC";$prev_groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R6)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . ($group["year"] + 1) . "' ORDER BY `excluded` ASC, `group` ASC";$next_groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R7)");if ($mode == "send-update"){	$authenticate = md5 (time());	$transaction = array ("creator" => $_SESSION["cid"], "roster" => $id, "note" => "", "address" => NULL, "phone" => NULL, "email" => NULL, "authenticate" => $authenticate);	while (list ($key, $value) = each ($_POST))	{		switch ($key)		{			case "button":				break;			case "roster_id":				$transaction["roster"] = $value;				break;			default:				if ($value != "")				{					$key = ucwords (str_replace ("_", " ", $key));					$transaction["note"] .= "[$key]\n$value\n\n";				}		}	}	$transaction["note"] = trim ($transaction["note"]);	$transaction["id"] = InsertArray ($transaction, "transactions");	$semi_rand = md5(time());	$mime_boundary = "==Multipart_Boundary_x{$semi_rand}x";	$body = "This is a multi-part MIME email.\n";	$body .= "\n--$mime_boundary\nContent-Type: text/plain; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n";	$text = "<< Update for " . $group["year"] . " " . $group["group"] . " >>\n\n";	$text .= stripslashes ($transaction["note"]) . "\n";	$body .= $text . "\nPoint your web browser to http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . " to check on the status of this update.";	$body .= "\n--$mime_boundary\nContent-Type: text/html; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n";	$html = str_replace (array ("<< ", " >>", "[", "]\n","\n"), array ("<h3>", "</h3>\n\n<dl>\n", "\t<dt>", "\n\t<dd>", "<br>\n"), $text);	$html = str_replace (array ("\n<br>", "><br>", "<br>\n\t<dd>"), array ("", ">", "\n\t<dd>"), $html);	$body .= "<html>\n\n<head>\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n\n<body>\n\n$html\n</dl>\n\n<p><a href=\"http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . "\">Click here</a> to check on the status of this update.</p>\n\n</body>\n\n</html>\n";	$headers = Name ($_SESSION["cid"], "From: %n %L");	$sql = "SELECT * FROM `emails` AS e JOIN `email_associations` AS ea ON ea.`email_id` = e.`email_id` JOIN `contacts` AS c ON c.`contact_id` = ea.`contact_id` WHERE c.`contact_id` = '" . $_SESSION["cid"] . "' LIMIT 1";	$result = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R8)");	if (mysql_num_rows ($result) > 0)	{		$row = mysql_fetch_assoc ($result);		$headers .= "<" . $row["email"] . ">";	}	else	{		$headers .= "<database@cottonwoodgulch.org>";	}	$headers .= "\nContent-Type: multipart/alternative; boundary=\"$mime_boundary\"";	if (mail ("database@cottonwoodgulch.org", "Update for " . $group["year"] . " " . $group["group"], $body, $headers))	{		header ("Location: roster.php?mode=view&id=$id&flag=Thank+you+for+updating+the+" . $group["year"] . "+" . str_replace (" ", "+", $group["group"]) . "+roster.+Your+update+will+be+posted+online+in+the+next+few+days.");	}	else	{		header ("Location: index.php?script+logic+error+(R9,+your+update+for+" . Name ($id, "%n %L") . "+was+lost)");	}}DocType();?><html><head><?phpif ($mode == "print"){	echo "\t<title>" . $group ["year"] . " " . $group["group"] . "</title>\n";	echo "\t<link rel=\"stylesheet\" href=\"../output.css\">\n";}else{?>	<link rel="stylesheet" href="../stylesheet.css"><?php}?>	<script src="../../../javascript/lib.js"></script></head><body><?phpif ($mode != "print"){?><table class="menu" width="98%">	<tr>		<td><a href="index.php">Search</a></td>		<td nowrap><a href="roster.php?mode=csv&id=<?php echo $id; ?>">Export CSV</a></td>		<td nowrap><a href="roster.php?mode=print&id=<?php echo $id; ?>" target="_blank">Print</a></td>		<td width="100%" align="right">Groups</td>	</tr></table><?php	echo "<h3>" . ($group["year"] > 0 ? $group ["year"] . " " : "") . $group["group"] . "</h3>\n\n";	if ($flag != "")	{		echo "<p class=\"flag\">$flag If you have any questions, please contact <a href=\"mailto:webmaster@cottonwoodgulch.org\">the webmaster.</a></p>\n";	}	echo "<p>" . ($group["log"] ? "Log" : "<b>No log</b>") . " on file for this group</p>\n\n";}else{?><table>	<tr valign="middle">		<td><img src="../graphics/logo.gif" width="44" height="44" border="0"></td>		<td><?php echo "<h3>" . ($group["year"] > 0 ? $group ["year"] . " ": "") . $group["group"] . "</h3>"; ?><p><i>Cottonwood Gulch Foundation</i></p></td>	</tr></table><?php}if (($mode != "print") && ($mode != "update")){?><table width="100%">	<tr valign="top">		<td width="100%" nowrap><?php}if ($mode != "update"){	$counter = 0;	if ((mysql_num_rows ($roster) < 1) || ($id === NULL))	{		echo "<p>This roster has not yet been entered.</p>\n";	}	else	{		echo "<dl>\n";		$is_staff = false;		while ($entry = mysql_fetch_assoc ($roster))		{			if ($is_staff != $entry["is_staff"])			{				$is_staff = true;				$counter = 0;				echo "\t<dt>Staff\n";			}			echo "\t\t<dd>" . ($mode != "print" ? "<a target=\"content\" href=\"../complete/contacts.php?detail=summary.php&cid=" . $entry["contact_id"] . "\">" : "") . ++$counter . ". " . Name ($entry["contact_id"]) . ((strlen ($entry["role"]) > 0) && (($entry["role"] != "Trekker") && ($entry["role"] != "Staff")) ? " (" . $entry["role"] . ")" : "") . ($mode != "print" ? "</a>" : "") . "</p>\n";		}	}	if ($mode != "print")	{?>		</td>		<td nowrap><dl><?phpif (mysql_num_rows ($groups) > 0){	if ($group["year"] > 0)	{		echo "\n<dt>Other Expeditions in " . $group["year"];	}	else	{		echo "\n<dt>Other Recurring Groups";	}	while ($g = mysql_fetch_assoc ($groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}if (mysql_num_rows ($prev_groups) > 0){	echo "\n<dt>" . ($group["year"] - 1) . " Expeditions";	while ($g = mysql_fetch_assoc ($prev_groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}if (mysql_num_rows ($next_groups) > 0){	echo "\n<dt>" . ($group["year"] + 1) . " Expeditions";	while ($g = mysql_fetch_assoc ($next_groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}?>		</dl></td>	</tr></table><?php	}}else{?><form method="post" action="roster.php?mode=send-update&id=<?php echo $id; ?>"><input name="roster_id" type="hidden" value="<?php echo $id; ?>"><dl>	<dt>Additional Information</dt>	<dd>Please explain what needs to updated, corrected, deleted or otherwise changed in this roster.	<dd><textarea name="Roster Update" cols="60" rows="5"></textarea>	<dt><input name="button" type="submit" value="Send Information"></dl></form><?php}?></body></html><?php} // csv?>