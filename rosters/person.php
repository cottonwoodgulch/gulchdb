<?phprequire_once "../library.inc.php";session_start ();header("Cache-control: private"); // IE 6$id = (isset ($_GET["id"]) ? $_GET["id"] : header ("Location: index.php?flag=script+logic+error+(P1)"));$mode = (isset ($_GET["mode"]) ? $_GET["mode"] : "view");$flag = (isset ($_GET["flag"]) ? stripslashes ($_GET["flag"]) : NULL);if (!isset ($_SESSION["authenticated"]) || $_SESSION["authenticated"] !== true){	$_SESSION["login_redirect"] = "person.php?id=$id&mode=$mode&flag=$flag";	header ("Location: login.php");}$now = getdate();if ($now["mon"] >= 9){	$curr_year = $now["year"] + 1;}else{	$curr_year = $now["year"];}function Pronoun ($person){	switch ($person["gender"])	{		case "Male":			return "He";		case "Female":			return "She";		default:			return Name ($person["contact_id"], "%n");	}}switch ($mode){case "send-update":	$address = array("owner_id" => $id);	$phone = array("owner_id" => $id);	$email = array("owner_id" => $id);	$authenticate = md5 (time());	$transaction = array ("creator" => $_SESSION["cid"], "contact" => $id, "type" => 1, "note" => "", "address" => NULL, "phone" => NULL, "email" => NULL, "authenticate" => $authenticate);	while (list ($key, $value) = each ($_POST))	{		switch ($key)		{			case "button":				break;			case "street_address_1":			case "street_address_2":			case "city":			case "state":			case "postal_code":			case "country":				$address[$key] = ($value != "" ? $value : NULL);				break;			case "number":			case "phone_type_id":				$phone[$key] = ($value != "" ? $value : NULL);				break;			case "email":				$email[$key] = ($value != "" ? $value : NULL);				break;			default:				if ($value != "")				{					$key = ucwords (str_replace ("_", " ", $key));					$transaction["note"] .= "[$key]\n$value\n\n";				}		}	}	$transaction["note"] = trim ($transaction["note"]);	$html = "<h3>Update for " . Name ($id, "%n %L") . "</h3>\n<dl>\n";//	if ($address["street_address_1"] || $address["street_address_2"] || $address["city"] || $address["state"] || $address["postal_code"] || $address["country"])	{		$transaction["address"] = InsertArray ($address, "transaction_addresses");		$html .= "<dt>New Address,</dt>\n";		$html .= "<dd>" . $address["street_address_1"] . "</dd>\n";		$html .= ($address["street_address_2"] != "" ? "<dd>" . $address["street_address_2"] . "</dd>\n" : "");		$html .= trim ("<dd>" . $address["city"] . ($address["state"] != "" ? ", " . $address["state"] : "") . ($address["postal_code"] != "" ? " " . $address["postal_code"] : "")) . "</dd>\n";		$html .= ($address["country"] != "" ? "<dd>" . $address["country"] . "</dd>\n" : "");		$html .= "\n";	}	if ($phone["number"])	{		$transaction["phone"] = InsertArray ($phone, "transaction_phones");		$sql = "SELECT * FROM `phone_types` WHERE `phone_type_id` = '" . $phone["phone_type_id"] . "' LIMIT 1";		$result = mysql_query ($sql) or header ("Location: index.php?MySQL+error+(P11)");		$row = mysql_fetch_assoc ($row);		$phone["type"] = ($row ? $row["phone_type"] : "");		$html .= "<dt>New Phone</dt>\n";		$html .= trim ("<dd>" . $phone["number"] . " " . $phone["type"]) . "</dd>\n";	}	if ($email["email"])	{		$transaction["email"] = InsertArray ($email, "transaction_emails");		$html .= "<dt>New Email</dt>\n";		$html .= "<dd>" . $email["email"] . "</dd>\n";	}	$html .= str_replace (array ("[", "]\n"), array ("<dt>", "</dt>\n<dd>"), $transaction["note"]);	$transaction["id"] = InsertArray ($transaction, "transactions");	$body .= "<html>\n\n<head>\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n\n<body>\n\n$html\n</dl>\n\n<p>Go to <a href=\"http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . "\">http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . "</a> to check on the status of this update.</p>\n\n</body>\n\n</html>\n";	$sql = "SELECT * FROM `contacts` AS c JOIN `email_associations` AS a ON a.`contact_id` = c.`contact_id` JOIN `emails` AS e ON e.`email_id` = a.`email_id` WHERE c.`contact_id` = '" . $_SESSION["cid"] . "' LIMIT 1";	$result = mysql_query ($sql);	if ($creator = mysql_fetch_assoc ($result))	{		$confirmation = "<html>\n\n<head>\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n\n<body>\n\n$html\n</dl>\n" . ($now["mon"] >= 5 && $now["mon"] <= 8 ? "<p>Please be aware that during the summer months (roughly May - August), it may take quite some time for your update to be entered -- the Gulch staff are fairly absorbed in making sure that all of the Treks are running smoothly!" : "") . "<p>If you have any questions or concerns, please do not hesitate to contact our webmaster at <a href=\"mailto:webmaster@cottonwoodgulch.org\">webmaster@cottonwoodgulch.org</a>.</p>\n</body>\n\n</html>\n";		mail_html (Name ($_SESSION["cid"], "%n %L <{$creator["email"]}>"), "Thank you!", $confirmation, "From: Online Rosters <database@cottonwoodgulch.org>");	}	if (mail_html ("database@cottonwoodgulch.org", "Update for " . Name ($id, "%n %L"), $body, Name ($_SESSION["cid"], "From: %n %L <database@cottonwoodgulch.org>")))	{		header ("Location: person.php?mode=view&id=$id&flag=Thank+you+for+updating " . Name ($id, "%n") . "'s+information.+Your+update+will+be+posted+online+in+the+next+few+days.");	}	else	{		header ("Location: index.php?script+logic+error+(P8,+your+update+for+" . Name ($id, "%n %L") . "+was+lost)");	}	break;	case "request":		$authenticate = md5 (time());		$transaction = array ("creator" => $_SESSION["cid"], "contact" => $id, "type" => 2, "authenticate" => $authenticate);		$transaction["id"] = InsertArray ($transaction, "transactions");		$sql = "SELECT * FROM `contacts` AS c JOIN `email_associations` AS a ON a.`contact_id` = c.`contact_id` JOIN `emails` AS e ON e.`email_id` = a.`email_id` WHERE c.`contact_id` = '$id' LIMIT 1";		$result = mysql_query ($sql);		if ($contact = mysql_fetch_assoc ($result))		{			$html = "<html>\n<head>\n<link rel=\"stylesheet\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n<body>\n<h3>" . Name ($_SESSION["cid"], "%T %F \"%N\" %M %L %D") . " has requested your contact information</h3>\n<p>" . Name ($_SESSION["cid"], "%n %L") . " requested your contact information via the Cottonwood Gulch Foundation's <a href=\"http://www.cottonwoodgulch.org/rosters/\">online rosters.</a></p>\n<p>If you wish to provide your contact information to this person, click on <a href=\"http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=yes&authenticate={$transaction["authenticate"]}\">this link</a> or paste it into your web browser: <a href=\"http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=yes&authenticate={$transaction["authenticate"]}\">http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=yes&authenticate={$transaction["authenticate"]}</a></p>\n<p>If you do not wish to provide your contact information to this person, click on <a href=\"http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=no&authenticate={$transaction["authenticate"]}\">this link</a> or paste it into your web browser: <a href=\"http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=no&authenticate={$transaction["authenticate"]}\">http://www.cottonwoodgulch.org/php/db/rosters/request.php?id={$transaction["id"]}&action=no&authenticate={$transaction["authenticate"]}</a></p>\n<p>If you have any questions about this, or want to know more about the online rosters, please do not hesitate to contact our webmaster at <a href=\"mailto:webmaster@cottonwoodgulch.org\">webmaster@cottonwoodgulch.org</a>.</p>\n</body>\n</html>\n";			mail_html (Name ($id, "%n %L <{$contact["email"]}>"), Name ($_SESSION["cid"], "Information Request from %n %L"), $html, "From: Online Rosters <database@cottonwoodgulch.org>");			$sql = "SELECT * FROM `contacts` AS c JOIN `email_associations` AS a ON a.`contact_id` = c.`contact_id` JOIN `emails` AS e ON e.`email_id` = a.`email_id` WHERE c.`contact_id` = '" . $_SESSION["cid"] . "' LIMIT 1";			$result = mysql_query ($sql);			if ($request = mysql_fetch_assoc ($result))			{				$html = "<html>\n<head>\n<link rel=\"stylesheet\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n</body>\n<h3>Your request has been sent</h3>\n<p>" . Name ($id, "%n %L") . " has been sent an email requesting his or her permission to release their contact information. Since your email is also in our database, you should hear back soon!</p>\n<p>If you have any questions, please do not hesitate to contact our webmaster at <a href=\"mailto:webmaster@cottonwoodgulch.org\">webmaster@cottonwoodgulch.org</a>.</p>\n</body>\n</html>\n";				mail_html (Name ($_SESSION["cid"], "%n %L <{$request["email"]}>"), "Confirmation", $html, "From: Online Rosters <database@cottonwoodgulch.org>");			}			else			{			mail_html ("database@cottonwoodgulch.org", Name ($_SESSION["cid"], "%n %L Requests Info - Intervention Needed"), "<html>\n<head>\n<link rel=\"stylesheet\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n</body>\n<h3>" . Name ($_SESSION["cid"], "%n %L") . " (" . $_SESSION["cid"] . ") requests information on " . Name ($id, "%n %L ($id)") . "</h3>\n<p>Go to <a href=\"http://10.0.0.254/php/db/rosters/transactions.php?id={$transaction["id"]}\">http://10.0.0.254/php/db/rosters/transactions.php?id={$transaction["id"]}</a> to check on the status of this transaction.</p>\n</body>\n</html>\n", "From: Online Rosters <database@cottonwoodgulch.org>");			}		}		else		{			$sql = "UPDATE `transactions` SET `status` = '10' WHERE `id` = '{$transaction["id"]}'";			mysql_query ($sql);			mail_html ("database@cottonwoodgulch.org", Name ($_SESSION["cid"], "%n %L Requests Info - Intervention Needed"), "<html>\n<head>\n<link rel=\"stylesheet\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n</body>\n<h3>" . Name ($_SESSION["cid"], "%n %L") . " (" . $_SESSION["cid"] . ") requests information on " . Name ($id, "%n %L ($id)") . "</h3>\n<p>Go to <a href=\"http://10.0.0.254/php/db/rosters/transactions.php?id={$transaction["id"]}\">http://10.0.0.254/php/db/rosters/transactions.php?id={$transaction["id"]}</a> to check on the status of this transaction.</p>\n</body>\n</html>\n", "From: Online Rosters <database@cottonwoodgulch.org>");			$sql = "SELECT * FROM `contacts` AS c JOIN `email_associations` AS a ON a.`contact_id` = c.`contact_id` JOIN `emails` AS e ON e.`email_id` = a.`email_id` WHERE c.`contact_id` = '" . $_SESSION["cid"] . "' LIMIT 1";			$result = mysql_query ($sql);			if ($request = mysql_fetch_assoc ($result))			{				$html = "<html>\n<head>\n<link rel=\"stylesheet\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n</body>\n<h3>Your request eill be sent</h3>\n<p>" . Name ($id, "%n %L") . "'s email is not in our database. This means that your request will require human intervention, which will take a little longer. But you should hear back soon!	</p>\n<p>If you have any questions, please do not hesitate to contact our webmaster at <a href=\"mailto:webmaster@cottonwoodgulch.org\">webmaster@cottonwoodgulch.org</a>.</p>\n</body>\n</html>\n";				mail_html (Name ($_SESSION["cid"], "%n %L <{$request["email"]}>"), "Confirmation", $html, "From: Online Rosters <database@cottonwoodgulch.org>");			}		}		$flag = "Your request is being processed. You should receive a confirmation email shortly. ";		break;}$sql = "SELECT * FROM `contacts` AS c LEFT JOIN `titles` AS t ON t.`title_id` = c.`title_id` LEFT JOIN `degrees` AS d ON d.`degree_id` = c.`degree_id` WHERE c.`contact_id` = '$id' LIMIT 1";$result = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(P2)");$person = mysql_fetch_assoc ($result) or header ("Location: index.php?flag=MySQL+error+(P3)");if ($person["gender"] == ""){	$person["gender"] = "relationship_type";}$sql = "SELECT aa.*, a.*, at.* FROM `addresses` AS a JOIN `address_associations` AS aa ON a.`address_id` = aa.`address_id` JOIN `address_types` AS at ON at.`address_type_id` = a.`address_type_id` WHERE aa.`contact_id` = '$id' ORDER BY at.rank ASC";$addresses = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(P4)");$sql = "SELECT * FROM `relationships` AS r JOIN `contacts` AS c ON c.`contact_id` = r.`contact_id` JOIN `relationship_types` AS t ON t.`relationship_type_id` = r.`relationship_type_id` WHERE r.`relative_id` = '$id' ORDER BY t.`rank` ASC, c.`primary_name` ASC, c.`first_name` ASC";$relationships = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(P5)");$sql = "SELECT m.*, r.*, g.*, l.* FROM `rosters` AS r JOIN `roster_memberships` AS m ON r.`roster_id` = m.`roster_id` JOIN `groups` AS g ON g.`group_id` = r.`group_id` LEFT JOIN `roles` AS l ON l.`role_id` = m.`role_id` WHERE m.`contact_id` = '$id' AND g.`excluded` = '0' AND r.`year` < '$curr_year' ORDER BY r.`year` ASC, g.`group` ASC";$groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(P6)");$sql = "SELECT * FROM `phone_types` WHERE 1 ORDER BY `rank`";$phone_types = mysql_query ($sql) or header ("Location: index.php?id=$id&flag=MySQL+error+(P7)");DocType();?><html><head>	<link rel="stylesheet" href="../../../components/stylesheet.css">	<link rel="stylesheet" href="section.css">	<script src="../../../javascript/lib.js"></script></head><body><table class="toolbar" width="98%">	<tr>		<td nowrap><a href="javascript:history.back();"><< Back</a></td>		<td><a href="index.php">Search</a></td><?php	if ($mode != "update")	{		echo "\n\t\t<td nowrap><a href=\"person.php?mode=update&id=$id\">Update " . Name ($id, "%n") . "'s Info</a></td>\n";	}	if ($mode != "request")	{		echo "\n\t\t<td nowrap><a href=\"person.php?mode=request&id=$id\">Request " . Name ($id, "%n") . "'s Info</a></td>\n";	}?>		<td nowrap><a href="logout.php">Log out</a></td>		<td width="100%" align="right">Online Group Rosters</td>	</tr></table><p class="name">Welcome <?php echo Name ($_SESSION["cid"], "%n!") . ($_SESSION["cid"] == $id ? " This is you!" : ""); ?></p><h3><?php echo str_replace (" \"\"", "", Name ($id,"%T %F \"%N\" %M %L %D")); ?></h3><?phpif ($flag != ""){	echo "<p class=\"flag\">$flag If you have any questions, please contact <a href=\"mailto:webmaster@cottonwoodgulch.org\">the webmaster.</a></p>\n";}if ($mode == "update"){	echo "<form name=\"update-$id\" method=\"post\" action=\"person.php?mode=send-update&id=$id\">\n";	echo "<dl>\n\t<dt>Alumni Notes\n\t\t<dd>Please share any information about " . Name ($id, "%n") . " that would be of interest to the Foundation archivist.\n\t\t<dd><textarea name=\"note\" cols=\"60\" rows=\"3\"></textarea>";}else if ($mode != "request"){	echo "<p>";}if ($mode == "update"){	echo "\n\t<dt>Contact Information\n\t\t<dl>\n";}else{	if (mysql_num_rows ($addresses) > 0)	{		$count = 0;		while ($a = mysql_fetch_assoc ($addresses))		{			$count++;			$print = true;			switch ($a["address_type_id"])			{				case 1: // Home					echo ($count == 1 ? Name ($id, "%n") : Pronoun ($person)) . " lives in ";					break;				case 3: // Work					$print = false;					break;				case 4: // Vacation					$print = false;					break;				case 5: // Temporary					echo ($count == 1 ? Name ($id, "%n") : Pronoun ($person)) . " is currently in ";					break;				case 6: // Physical					echo ($count == 1 ? Name ($id, "%n") : Pronoun ($person)) . " receives mail in ";					break;				case 7: // Old Roster					echo Name ($id, "%n") . "'s last known address is from the " . $a["custom"] . " roster. At that time, " . strtolower (Pronoun ($person)) . " lived in ";					break;			}			if ($print)			{				echo $a["city"] . ", " . $a["state"] . ((strlen ($a["country"]) > 0) && ($a["country"] != "United States") ? " " . $a["country"] : "") . " (updated " . date ("F, Y", mktime (0, 0, 0, substr ($a["modified"], 5, 2), substr ($a["modified"], 8, 2), substr ($a["modified"], 0, 4))) . "). ";			}		}	}	else	{		if ($person["deceased"])		{			echo Name ($id, "%n") . " is deceased. ";		}		else		{			echo "The Foundation does not know " . Name ($id, "%n") . "'s current address. ";		}	}}if ($mode == "update"){	$fill = mysql_fetch_assoc ($addresses);	echo "\n\t\t\n\t<dt>Address\n\t\t<dd>";?><table>			<tr valign="top">				<td class="label2">Street Address</td>				<td colspan="5"><input name="street_address_1" type="text" size="35"><br>					<input name="street_address_2" type="text" size="35"></td>			</tr>			<tr valign="top">				<td class="label2">City</td>				<td><input name="city" type="text" size="15" value="<?php echo $fill["city"]; ?>"></td>				<td class="label2">State</td>				<td><input name="state" type="text" size="5" value="<?php echo $fill["state"]; ?>"></td>				<td class="label2">Zip Code</td>				<td><input name="postal_code" type="text" size="10"></td>			</tr>			<tr valign="top">				<td class="label2">Country</td>				<td colspan="5"><input name="country" type="text" size="20" value="<?php echo (isset ($fill["country"]) ? $fill["country"] : "United States"); ?>"></td>			</tr>		</table><?php	echo "\n\t<dt>Phone\n\t\t<dd><input name=\"number\" type=\"text\" size=\"15\"> <select name=\"phone_type_id\">\n";	while ($pt = mysql_fetch_assoc ($phone_types))	{		echo "\t\t\t<option value=\"" . $pt["phone_type_id"] . "\"" . ($pt["phone_type_id"] == 2 ? " selected" : "") . ">" . $pt["phone_type"] . "</option>\n";	}	echo "\t\t</select>\n\t<dt>Email\n\t\t<dd><input name=\"email\" type=\"text\" size=\"60\">\n\t</dl>";	echo "\n\t<dt>Family\n\t\t";}if (mysql_num_rows ($relationships) > 0 && $mode != "update"){	$count = 0;	while ($r = mysql_fetch_assoc ($relationships))	{		$count++;		echo ($count == 1 ? Name ($id, "%n") : Pronoun ($person)) . " is the " . $r[$person["gender"]] . " of <a href=\"person.php?id=" . $r["contact_id"] . "\">" . str_replace (" \"\"", "", Name ($r["contact_id"], "%F %M \"%N\" %L")) . "</a>. ";	}}if ($mode == "update"){	echo "\n\t<dl>\n\t\t<dd>Please note any corrections and/or additions to " . Name ($id, "%n") . "'s family, and their relationship to " . Name ($id, "%n") . ".\n\t\t<dd><textarea name=\"additional_relationships\" cols=\"60\" rows=\"3\" align=\"top\"></textarea>\n\t</dl>\n";}if (mysql_num_rows ($groups) > 0){	if ($mode == "update")	{		echo "\n\t<dt>Expeditions\n";	}	else	{		echo "\n<h4>Expeditions</h4>\n<dl>\n";	}	if ($mode != "update")	{		while ($g = mysql_fetch_assoc ($groups))		{			echo "\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["year"] . " " . $g["group"] . ((strlen ($g["role"]) > 0) && ($g["role"] != "Trekker") ? ", " . $g["role"] : "") . "</a>\n";		}	}	if ($mode != "update")	{		echo "</dl>\n";	}}if ($mode == "update"){	echo "\n\t<dl>\n\t\t\t<dd>Please note any corrections and/or additions to the list of expeditions of which " . Name ($id, "%n") . " was a member, including the role that " . strtolower (Pronoun ($person)) . " held in the group (QM, CA, Group Leader, etc.).\n\t\t\t<dd><textarea name=\"additional_groups\" cols=\"60\" rows=\"3\"></textarea>\n\t</dl>\n</dl>\n";	echo "\t<dt><input name=\"button\" type=\"submit\" value=\"Send Information\"><input name=\"button\" type=\"reset\" value=\"Reset\">\n";	echo "</form>\n";}?></body></html>