<?phprequire_once "../library.inc.php";session_start ();header("Cache-control: private"); // IE 6$id = (isset ($_GET["id"]) ? $_GET["id"] : header ("Location: index.php?flag=script+logic+error+(R1)"));$mode = (isset ($_GET["mode"]) ? $_GET["mode"] : "view");$flag = (isset ($_GET["flag"]) ? stripslashes ($_GET["flag"]) : NULL);if (!isset ($_SESSION["authenticated"]) || $_SESSION["authenticated"] !== true){	$_SESSION["login_redirect"] = "roster.php?id=$id&mode=$mode&flag=$flag";	header ("Location: login.php?redirect=");}$now = getdate();if ($now["mon"] >= 9){	$curr_year = $now["year"] + 1;}else{	$curr_year = $now["year"];}$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` JOIN `roster_memberships` AS m ON m.`roster_id` = r.`roster_id` JOIN `contacts` AS c ON c.`contact_id` = m.`contact_id` LEFT JOIN `roles` AS l ON l.`role_id` = m.`role_id` WHERE r.`roster_id` = '$id' ORDER BY l.`is_staff` ASC, c.`primary_name` ASC, c.`first_name` ASC";$roster = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R2)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` = '$id' LIMIT 1";$result = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R3)");$group = mysql_fetch_assoc ($result) or header ("Location: index.php?flag=script+logic+error+(R4)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . $group["year"] . "' AND g.`excluded` = '0' ORDER BY `group` ASC";$groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R5)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . ($group["year"] - 1) . "' AND r.`year` >= '1926' AND g.`excluded` = '0' ORDER BY `group` ASC";$prev_groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R6)");$sql = "SELECT * FROM `rosters` AS r JOIN `groups` AS g ON r.`group_id` = g.`group_id` WHERE r.`roster_id` <> '$id' AND r.`year` = '" . ($group["year"] + 1) . "' AND r.year <> '$curr_year' AND g.`excluded` = '0' ORDER BY `group` ASC";$next_groups = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R7)");if ($mode == "send-update"){	$authenticate = md5 (time());	$transaction = array ("creator" => $_SESSION["cid"], "roster" => $id, "note" => "", "address" => NULL, "phone" => NULL, "email" => NULL, "authenticate" => $authenticate);	while (list ($key, $value) = each ($_POST))	{		switch ($key)		{			case "button":				break;			case "roster_id":				$transaction["roster"] = $value;				break;			default:				if ($value != "")				{					$key = ucwords (str_replace ("_", " ", $key));					$transaction["note"] .= "[$key]\n$value\n\n";				}		}	}	$transaction["note"] = trim ($transaction["note"]);	$transaction["id"] = InsertArray ($transaction, "transactions");		$semi_rand = md5(time());	$mime_boundary = "==Multipart_Boundary_x{$semi_rand}x"; 	$body = "This is a multi-part MIME email.\n";	$body .= "\n--$mime_boundary\nContent-Type: text/plain; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n";		$text = "<< Update for " . $group["year"] . " " . $group["group"] . " >>\n\n";	$text .= stripslashes ($transaction["note"]) . "\n";	$body .= $text . "\nPoint your web browser to http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . " to check on the status of this update.";	$body .= "\n--$mime_boundary\nContent-Type: text/html; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n";	$html = str_replace (array ("<< ", " >>", "[", "]\n","\n"), array ("<h3>", "</h3>\n\n<dl>\n", "\t<dt>", "\n\t<dd>", "<br>\n"), $text);	$html = str_replace (array ("\n<br>", "><br>", "<br>\n\t<dd>"), array ("", ">", "\n\t<dd>"), $html);	$body .= "<html>\n\n<head>\n\t<link rel=\"stylesheet\" type=\"text/css\" href=\"http://www.cottonwoodgulch.org/components/stylesheet.css\">\n</head>\n\n<body>\n\n$html\n</dl>\n\n<p><a href=\"http://10.0.0.254/php/db/rosters/transaction.php?id=" . $transaction["id"] . "\">Click here</a> to check on the status of this update.</p>\n\n</body>\n\n</html>\n";		$headers = Name ($_SESSION["cid"], "From: %n %L");	$sql = "SELECT * FROM `emails` AS e JOIN `email_associations` AS ea ON ea.`email_id` = e.`email_id` JOIN `contacts` AS c ON c.`contact_id` = ea.`contact_id` WHERE c.`contact_id` = '" . $_SESSION["cid"] . "' LIMIT 1";	$result = mysql_query ($sql) or header ("Location: index.php?flag=MySQL+error+(R8)");	if (mysql_num_rows ($result) > 0)	{		$row = mysql_fetch_assoc ($result);		$headers .= "<" . $row["email"] . ">";	}	else	{		$headers .= "<database@cottonwoodgulch.org>";	}	$headers .= "\nContent-Type: multipart/alternative; boundary=\"$mime_boundary\"";					if (mail ("database@cottonwoodgulch.org", "Update for " . $group["year"] . " " . $group["group"], $body, $headers))	{		header ("Location: roster.php?mode=view&id=$id&flag=Thank+you+for+updating+the+" . $group["year"] . "+" . str_replace (" ", "+", $group["group"]) . "+roster.+Your+update+will+be+posted+online+in+the+next+few+days.");	}	else	{		header ("Location: index.php?script+logic+error+(R9,+your+update+for+" . Name ($id, "%n %L") . "+was+lost)");	}}DocType();?><html><head><?phpif ($mode == "print"){	echo "\t<title>" . $group ["year"] . " " . $group["group"] . "</title>\n";	echo "\t<link rel=\"stylesheet\" href=\"../output.css\">\n";}else{?>	<link rel="stylesheet" href="../../../components/stylesheet.css">	<link rel="stylesheet" href="section.css"><?php}?>	<script src="../../../javascript/lib.js"></script></head><body><?phpif ($mode != "print"){?><table class="toolbar" width="98%">	<tr>		<td nowrap><a href="javascript:history.back();"><< Back</a></td>		<td><a href="index.php">Search</a></td><?phpif ($mode != "update"){	echo "\t\t<td nowrap><a href=\"roster.php?mode=print&id=$id\" target=\"_blank\">Print</a></td>\n";	echo "\t\t<td nowrap><a href=\"roster.php?mode=update&id=$id\">Update</a></td>\n";}?>		<td nowrap><a href="logout.php">Log out</a></td>		<td width="100%" align="right">Online Group Rosters</td>	</tr></table><p class="name">Welcome <?php echo Name ($_SESSION["cid"], "%n"); ?>!</p><?php	echo "<h3>" . $group ["year"] . " " . $group["group"] . "</h3>\n\n";	if ($flag != "")	{		echo "<p class=\"flag\">$flag If you have any questions, please contact <a href=\"mailto:webmaster@cottonwoodgulch.org\">the webmaster.</a></p>\n";	}	echo "<p>The Foundation " . ($group["log"] ? "has" : "does not have") . " a copy of this group's log in its archives." . ($group["log"] ? "" : " If you have a copy of this group log, please consider sharing it with us!") . "</p>\n\n";}else{?><table>	<tr valign="middle">		<td><img src="../graphics/logo.gif" width="44" height="44" border="0"></td>		<td><?php echo "<h3>" . $group ["year"] . " " . $group["group"] . "</h3>"; ?><p><i>Cottonwood Gulch Foundation</i></p></td>	</tr></table><?php}if (($mode != "print") && ($mode != "update")){?><table width="100%">	<tr valign="top">		<td width="100%" nowrap><?php}if ($mode != "update"){		if ((mysql_num_rows ($roster) < 1) || ($id === NULL))	{		echo "<p>This roster has not yet been entered.</p>\n";	}	else	{		echo "<dl>\n";		$is_staff = false;		while ($entry = mysql_fetch_assoc ($roster))		{			if ($is_staff != $entry["is_staff"])			{				$is_staff = true;				echo "\t<dt>Staff\n";			}			echo "\t\t<dd>" . ($mode != "print" ? "<a href=\"person.php?id=" . $entry["contact_id"] . "\">" : "") . str_replace (" \"\"", "", Name ($entry["contact_id"], "%F \"%N\" %M %L %D")) . ((strlen ($entry["role"]) > 0) && (($entry["role"] != "Trekker") && ($entry["role"] != "Staff")) ? " (" . $entry["role"] . ")" : "") . ($mode != "print" ? "</a>" : "") . "</p>\n";		}	}		if ($mode != "print")	{?>		</td>		<td nowrap><dl><?phpif (mysql_num_rows ($groups) > 0){	echo "\n<dt>Other Expeditions in " . $group["year"];	while ($g = mysql_fetch_assoc ($groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}if (mysql_num_rows ($prev_groups) > 0){	echo "\n<dt>" . ($group["year"] - 1) . " Expeditions";	while ($g = mysql_fetch_assoc ($prev_groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}if (mysql_num_rows ($next_groups) > 0){	echo "\n<dt>" . ($group["year"] + 1) . " Expeditions";	while ($g = mysql_fetch_assoc ($next_groups))	{		echo "\n\t\t<dd><a href=\"roster.php?id=" . $g["roster_id"] . "\">" . $g["group"] . "</a>";	}}?>		</dl></td>	</tr></table><?php	}}else{?><form method="post" action="roster.php?mode=send-update&id=<?php echo $id; ?>"><input name="roster_id" type="hidden" value="<?php echo $id; ?>"><dl>	<dt>Additional Information</dt>	<dd>Please explain what needs to updated, corrected, deleted or otherwise changed in this roster.	<dd><textarea name="Roster Update" cols="60" rows="5"></textarea>	<dt><input name="button" type="submit" value="Send Information"></dl></form><?php}?></body></html>