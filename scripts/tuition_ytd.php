<?phprequire_once ("../library.inc.php");require_once ("../csv.inc.php");$now = getdate();$year = (isset ($_GET["year"]) ? $_GET["year"] : $now["year"]);csv_start ($year . "_tuition_year-to-date");csv ("Group");csv ("Enrolled");csv ("Details");csv ("Base Tuition");csv ("Received");csv ("Scholarship");csv ("Henio Scholarship");csv ("Early Registration Discount");csv ("Alumni Discount");csv ("QM/CA Discount");csv ("Referral Discount");csv ("Other Discounts");csv ("Balance");csv_newline ();// pick all of the groups for the specified roster year$sql = "SELECT * FROM groups AS g JOIN rosters AS r ON r.group_id = g.group_id WHERE r.year = '$year' ORDER BY g.short_name ASC";$groups = mysql_query ($sql) or exit (mysql_error());// zero all of the column totals$total_enrolled = 0;$total_tuitions = 0;$total_payments = 0;$total_scholarships = 0;$total_henio_scholarships = 0;$total_balance = 0;$total_early_registration_discounts  = 0;$total_alumni_discounts = 0;$total_qm_ca_discounts = 0;$total_referral_discounts = 0;$total_general_discounts = 0;// loop through all of the groupswhile ($g = mysql_fetch_assoc ($groups)){	// if the group is not one of the excluded groups, look up all of its members	// FIX THIS: This should probably use the excluded bit in the group record	if (($g["short_name"] <> "Board") && ($g["short_name"] <> "Recruiters")&& ($g["short_name"] <> "BC Staff")&& ($g["short_name"] <> "St. Stephen's IQ"))	{		csv ($g["short_name"]);		// find out how many kinds of tuitions are being paid by enrollees		$sql = "SELECT * FROM tuitions AS t JOIN roster_memberships AS m ON m.roster_id = t.roster_id JOIN tuition_types AS tt ON tt.tuition_type_id = m.tuition_type_id AND t.tuition_type_id = tt.tuition_type_id WHERE m.roster_id = '" . $g["roster_id"] . "' AND m.tuition_type_id >= '1' GROUP BY m.tuition_type_id";		$result = mysql_query ($sql) or exit (mysql_error());		// figure out the subtotals by type of tuition		$tuitions = 0;		$temp_enrolled = NULL;		$combined_enrolled = 0;		while ($tuition_type = mysql_fetch_assoc ($result))		{			$sql = "SELECT count(roster_membership_id) AS enrolled FROM roster_memberships WHERE roster_id = '" . $g["roster_id"] . "' AND tuition_type_id = '" . $tuition_type["tuition_type_id"] . "'";			$result2 = mysql_query ($sql) or exit (mysql_error());			$a = mysql_fetch_assoc ($result2);			$enrolled = $a["enrolled"];			$temp_enrolled = dbAddToList ($temp_enrolled, "$enrolled {$tuition_type["tuition_type"]} @ \${$tuition_type["amount"]}");			$total_enrolled += $enrolled;			$combined_enrolled += $enrolled;			$tuitions += $enrolled * $tuition_type["amount"];		}		csv ($combined_enrolled);		csv ($temp_enrolled);		csv ($tuitions);		$total_tuitions += $tuitions;		// payments		$sql = "SELECT SUM(p.amount) AS payments FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND (p.payment_type_id = '2' OR p.payment_type_id = '8') GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$payments = $a["payments"];		csv ($payments);		$total_payments += $payments;		// scholarships		$sql = "SELECT SUM(p.amount) AS scholarships FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '4' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$scholarships = $a["scholarships"];		csv ($scholarships);		$total_scholarships += $scholarships;		// henio scholarships		$sql = "SELECT SUM(p.amount) AS henios FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '12' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$henios = $a["henios"];		csv ($henios);		$total_henio_scholarships += $henios;		// early registration		$sql = "SELECT SUM(p.amount) AS early FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '5' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$early = $a["early"];		csv ($early);		$total_early_registration_discounts  += $early;		// alumni		$sql = "SELECT SUM(p.amount) AS alumni FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '6' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$alumni = $a["alumni"];		csv ($alumni);		$total_alumni_discounts += $alumni;		// qm/ca		$sql = "SELECT SUM(p.amount) AS qm FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '9' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$qm = $a["qm"];		csv ($qm);		$total_qm_ca_discounts += $qm;		// referrals		$sql = "SELECT SUM(p.amount) AS referral FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '11' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$referral = $a["referral"];		csv ($referral);		$total_referral_discounts += $referral;		// general discounts		$sql = "SELECT SUM(p.amount) AS discount FROM payments AS p JOIN tuitions AS t ON t.tuition_id = p.tuition_id JOIN rosters AS r ON r.roster_id = t.roster_id WHERE r.roster_id = '" . $g["roster_id"] . "' AND p.payment_type_id = '10' GROUP BY r.roster_id";		$result = mysql_query ($sql) or exit (mysql_error());		$a = mysql_fetch_assoc ($result);		$discount = $a["discount"];		csv ($discount);		$total_general_discounts += $discount;		csv ($tuitions - $payments - $scholarships - $henios - $early - $alumni - $qm - $referral - $discount);		$total_balance += ($tuitions - $payments - $scholarships - $henios - $early - $alumni - $qm - $referral - $discount);		csv_newline ();	}}csv ("");csv ($total_enrolled);csv ("");csv ($total_tuitions);csv ($total_payments);csv ($total_scholarships);csv ($total_henio_scholarships);csv ($total_early_registration_discounts);csv ($total_alumni_discounts);csv ($total_qm_ca_discounts);csv ($total_referral_discounts);csv ($total_general_discounts);csv ($total_balance);csv_end ();?>