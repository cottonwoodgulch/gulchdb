<?phprequire_once ('../library.inc.php');set_time_limit (6000);$filename = "labels.csv";$sql = "SELECT a.* FROM addresses AS a			JOIN address_associations AS aa ON a.address_id = aa.address_id			JOIN contacts AS c ON c.contact_id = aa.contact_id			JOIN address_types AS at ON at.address_type_id = a.address_type_id			WHERE address_type <> 'Old Roster'			GROUP BY				a.address_id			ORDER BY				a.country ASC,				a.postal_code ASC";$addresses = mysql_query ($sql) or exit (mysql_error());header('Content-Type: text/x-csv');header('Expires: ' . gmdate('D, d M Y H:i:s') . ' GMT');// lem9 & loic1: IE need specific headers//if (PMA_USR_BROWSER_AGENT == 'IE') {	header('Content-Disposition: inline; filename="mailing-list.csv"');	header('Cache-Control: must-revalidate, post-check=0, pre-check=0');	header('Pragma: no-cache');/*} else {	header('Content-Disposition: attachment; filename="' . $filename . '"');	header('Pragma: no-cache');}*/echo '"name","address_line_1","address_line_2","city","state","postal_code","country"' . "\r";while ($address = mysql_fetch_assoc ($addresses)){	$sql = "SELECT * FROM contacts AS c				LEFT JOIN roster_memberships AS m ON m.contact_id = c.contact_id				LEFT JOIN rosters AS r ON r.roster_id = m.roster_id				LEFT JOIN groups AS g ON g.group_id = r.group_id				JOIN address_associations AS aa ON c.contact_id = aa.contact_id				JOIN contact_types AS ct ON ct.contact_type_id = c.contact_type_id				LEFT JOIN titles AS t ON t.title_id = c.title_id				LEFT JOIN degrees AS d ON d.degree_id = c.degree_id				WHERE					ct.contact_type = 'Individual' AND					((g.short_name <> 'Bosque' AND g.short_name <> 'AIS' AND g.short_name <> 'Business') OR						g.short_name IS NULL) AND					aa.address_id = " . $address['address_id'] . " AND					c.mailing_preference = 1 AND					c.deceased = 0				GROUP BY					c.contact_id				ORDER BY					c.primary_name ASC,					c.birth_date DESC,					g.short_name ASC";	$contacts = mysql_query ($sql) or exit (mysql_error());	$name = array();	$i = 0;	while ($contact = mysql_fetch_assoc ($contacts))	{		$sql = "SELECT *, min(at.rank) AS min_rank FROM address_associations AS aa					JOIN addresses AS a ON a.address_id = aa.address_id					JOIN address_types AS at ON at.address_type_id = a.address_type_id					WHERE aa.contact_id = '" . $contact['contact_id'] . "'					GROUP BY						a.address_id					ORDER BY						at.rank ASC					LIMIT 1";		$result = mysql_query ($sql) or exit (mysql_error());		$best_address = mysql_fetch_assoc ($result);		if ($best_address['address_id'] == $address['address_id'])		{			$name[$i] = array ($contact['title'],							   $contact['first_name'],							   $contact['middle_name'],							   $contact['primary_name'],							   $contact['degree'],							   $contact['nickname']);			$i++;		}	}	if (sizeof ($name) > 0)	{		$output = '';		reset ($name);		$i = 0;		$t = $name[$i][0];		$f = $name[$i][1];		$m = $name[$i][2];		$l = $name[$i][3];		$d = $name[$i][4];		$n = $name[$i][5];		$prev_l = $l;		do {			if ($l == $prev_l)				$output = dbAddToList ($output, ($n ? $n : $f), ', ');			else			{				$output = dbAddToList ($output, " $prev_l", '');				$output = dbAddToList ($output, ($n ? $n : $f), ' and ');			}			$prev_l = $l;			$i++;			if ($i < sizeof ($name))			{				$t = $name[$i][0];				$f = $name[$i][1];				$m = $name[$i][2];				$l = $name[$i][3];				$d = $name[$i][4];				$n = $name[$i][5];			}		} while ($i < sizeof ($name));		$output = dbAddToList ($output, " $prev_l", '');		$last_comma = strrpos ($output, ', ');		if ($last_comma !== false)			$output = substr ($output, 0, $last_comma) . ' and ' . substr ($output, $last_comma + 2);		$ampersand = strpos ($output, '&');		if ($ampersand !== false)			$output = substr ($output, 0, $ampersand) . 'and' . substr ($output, $ampersand + 1);		$label = '';		$label = dbAddToList ($label, "\"$output\"", ',');		$label = dbAddToList ($label, '"' . $address['street_address_1'] . '"', ',');		$label = dbAddToList ($label, '"' . $address['street_address_2'] . '"', ',');		$label = dbAddToList ($label, '"' . $address['city'] . '"', ',');		$label = dbAddToList ($label, '"' . $address['state'] . '"', ',');		$label = dbAddToList ($label, '"' . $address['postal_code'] . '"', ',');		$label = dbAddToList ($label, ($address['country'] <> 'United States' ? '"' . $address['country'] . '"' : ""), ',');		echo "$label\r";	}}?>