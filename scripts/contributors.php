<?phprequire_once ("../library.inc.php");require_once ("../csv.inc.php");$now = getdate();$year = (isset ($_GET["year"]) ? $_GET["year"] : $now["year"]);csv_start ($year . "_contributors");$sql = "SELECT * FROM `contacts` AS c		JOIN `donations` AS d ON d.`donor_id` = c.`contact_id`		LEFT JOIN `funds` AS f ON f.`fund_id` = d.`fund_id`		WHERE d.`date` >= '$year-10-01' AND d.`date` < '" . ($year + 1) . "-10-01'		GROUP BY d.donation_id		ORDER BY f.`fund` ASC, c.`primary_name` ASC, c.`first_name` ASC";$donations = mysql_query ($sql) or exit (mysql_error());function SetCategory ($amount){	$category = "Contributor";	if ($amount >= 5000)	{		$category = "Pacesetter";	}	else if ($amount >= 1000)	{		$category = "Benefactor";	}	else if ($amount >= 500)	{		$category = "Sponsor";	}	else if ($amount >= 100)	{		$category = "Donor";	}	return $category;}function PrintDonor ($d){	csv (($d["anonymous"] ? "Anonymous" : $d["actual_name"]));	csv (SetCategory ($d["amount"]));	csv ($d["purpose"]);	csv ($d["amount"]);	csv ($d["donation_id"]);	csv ($d["count"]);	csv_newline ();}$prev_fund = NULL;$prev_donor = array("donor_id" => NULL);while ($donation = mysql_fetch_assoc ($donations)){	// new header if we're in a new fund	if ($donation["fund"] != $prev_fund)	{		if ($prev_donor["donor_id"] !== NULL)		{			PrintDonor ($prev_donor);		}		$prev_donor = array("donor_id" => NULL);		csv ($donation["fund"]);		csv_newline ();		$prev_fund = $donation["fund"];		csv ("Donor");		csv ("Category");		csv ("Purpose");		csv ("Amount");		csv ("Donation ID");		csv ("Number of Donations");		csv_newline ();	}	$sql = "SELECT * FROM `contacts` AS c			JOIN `donation_associations` AS da ON da.`contact_id` = c.`contact_id`			WHERE da.`contact_id` <> {$donation["donor_id"]} AND da.`donation_id` = {$donation["donation_id"]}";	$others = mysql_query ($sql) or exit (mysql_error());	$i = 0;	$actual_name = Name ($donation["donor_id"], "%F %M %L %D");	if (mysql_num_rows ($others) > 0)	{		while ($c = mysql_fetch_assoc ($others))		{			$actual_name = dbAddToList ($actual_name, Name ($c["contact_id"], "%F %M %L %D"));		}	}	if ($donation["donor_id"] == $prev_donor["donor_id"])	{		while (list ($key, $value) = each ($donation))		{			switch ($key)			{				case "amount":					$prev_donor["amount"] += $value;					break;				case "purpose":					$prev_donor["purpose"] = dbAddToList ($prev_donor["purpose"], $value);					break;				case "donation_id":					$prev_donor["donation_id"] = dbAddToList ($prev_donor["donation_id"], $value);					break;				default:					break;			}		}		$prev_donor["count"]++;	}	else	{		if ($prev_donor["donor_id"] !== NULL)		{			PrintDonor ($prev_donor);		}		$prev_donor = array ();		while (list ($key, $value) = each ($donation))		{			$prev_donor[$key] = $value;		}		$prev_donor["actual_name"] = $actual_name;		$prev_donor["count"] = 1;	}}PrintDonor ($prev_donor);csv_end ();?>