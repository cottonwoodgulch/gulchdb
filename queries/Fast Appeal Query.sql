create temporary table ta (select c1.contact_id, a.address_id, at.rank, min(at.rank) as min_a_rank	   from contacts as c1	   join address_associations as aa on aa.contact_id = c1.contact_id	   join addresses as a on a.address_id = aa.address_id	   join address_types as at on at.address_type_id = a.address_type_id	   group by c1.contact_id	   having at.rank = min_a_rank	   order by c1.contact_id asc, at.rank asc);create temporary table tc (select c2.contact_id from contacts as c2 left join roster_memberships as m on m.contact_id = c2.contact_id left join rosters as r on r.roster_id = m.roster_id left join groups as g on g.group_id = r.group_id where (g.short_name <> 'AIS' and g.short_name <> 'Bosque' and g.short_name <> 'St. Stephen\'s IQ' and g.short_name <> 'Business') or g.short_name is null group by c2.contact_id);SELECT count( c.contact_id ) as recipients, t.title, c.first_name, c.nickname, c.primary_name, d.degree, a.street_address_1, a.street_address_2, a.city, a.state, a.postal_code, a.countryFROM contacts AS cJOIN tc ON tc.contact_id = c.contact_idLEFT  JOIN degrees AS d ON d.degree_id = c.degree_idLEFT  JOIN titles AS t ON t.title_id = c.title_idJOIN ta ON c.contact_id = ta.contact_idJOIN addresses AS a ON a.address_id = ta.address_idGROUP  BY a.address_idORDER  BY a.postal_code ASC;